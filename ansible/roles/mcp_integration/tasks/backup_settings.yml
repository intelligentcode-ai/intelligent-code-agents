---
# Create backup of existing claude.json before making changes

- name: Set default settings path
  ansible.builtin.set_fact:
    settings_json_path: "{{ ansible_env.HOME }}/.claude.json"
  when: settings_json_path is not defined

- name: Check if claude.json exists
  ansible.builtin.stat:
    path: "{{ settings_json_path }}"
  register: settings_file_stat

- name: Create backup filename with timestamp
  ansible.builtin.set_fact:
    settings_backup_file: "{{ settings_json_path }}.backup.{{ ansible_date_time.epoch }}"

- name: Create backup of existing claude.json
  ansible.builtin.copy:
    src: "{{ settings_json_path }}"
    dest: "{{ settings_backup_file }}"
    mode: "0600"
    backup: false
  when: settings_file_stat.stat.exists
  register: backup_result
  failed_when: false

- name: Handle backup creation failure
  ansible.builtin.set_fact:
    mcp_integration_error: "Failed to create backup of claude.json"
  when:
    - settings_file_stat.stat.exists
    - backup_result is defined
    - backup_result.failed

- name: Initialize empty settings if file doesn't exist
  ansible.builtin.set_fact:
    current_settings: {}
  when: not settings_file_stat.stat.exists

- name: Read current claude.json if exists
  ansible.builtin.slurp:
    src: "{{ settings_json_path }}"
  register: current_settings_raw
  when: settings_file_stat.stat.exists
  failed_when: false

- name: Parse existing claude.json
  ansible.builtin.set_fact:
    current_settings: "{{ current_settings_raw.content | b64decode | from_json }}"
  when:
    - settings_file_stat.stat.exists
    - not current_settings_raw.failed
  failed_when: false
  register: settings_parse_result

- name: Handle corrupted claude.json
  when:
    - settings_file_stat.stat.exists
    - settings_parse_result.failed
  block:
    - name: Log corrupted settings warning
      ansible.builtin.debug:
        msg: "Warning: Existing claude.json is corrupted. Using backup and creating fresh settings."

    - name: Initialize empty settings for corrupted file
      ansible.builtin.set_fact:
        current_settings: {}

- name: Ensure settings directory exists
  ansible.builtin.file:
    path: "{{ settings_json_path | dirname }}"
    state: directory
    mode: "0755"

- name: Log backup status
  ansible.builtin.debug:
    msg: >-
      Settings backup created: {{ settings_backup_file
      if settings_file_stat.stat.exists else 'No existing settings to backup' }}
