---
# Process a single MCP server configuration with environment variable resolution

- name: Set current MCP server details
  ansible.builtin.set_fact:
    mcp_name: "{{ mcp_server.key }}"
    mcp_config: "{{ mcp_server.value }}"

- name: Validate MCP server name
  ansible.builtin.fail:
    msg: "MCP server name cannot be empty"
  when: mcp_name | length == 0

- name: Initialize processed MCP config
  ansible.builtin.set_fact:
    processed_mcp_config:
      ansible.builtin.command: "{{ mcp_config.command }}"

- name: Process command arguments with environment variable resolution
  when: mcp_config.args is defined and mcp_config.args | length > 0
  block:
    - name: Resolve environment variables in command arguments
      ansible.builtin.set_fact:
        processed_args: []

    - name: Process each argument for environment variable resolution
      ansible.builtin.set_fact:
        processed_args: "{{ processed_args + [resolved_arg] }}"
      vars:
        var_name_match: "{{ item | regex_search('\\$\\{([^}]+)\\}', '\\1') }}"
        var_name: "{{ var_name_match if var_name_match else '' }}"
        # Resolve: check loaded_env_vars first, then system env, else use original
        resolved_arg: >-
          {{ item | regex_replace('\\$\\{' + var_name + '\\}', loaded_env_vars[var_name])
          if (var_name_match and var_name in loaded_env_vars)
          else (item | regex_replace('\\$\\{' + var_name + '\\}', lookup('env', var_name))
          if (var_name_match and lookup('env', var_name)) else item) }}
      loop: "{{ mcp_config.args | default([]) }}"

    - name: Add processed arguments to config
      ansible.builtin.set_fact:
        processed_mcp_config: "{{ processed_mcp_config | combine({'args': processed_args}) }}"

- name: Process environment variables if defined
  when: mcp_config.env is defined
  block:
    - name: Initialize processed environment
      ansible.builtin.set_fact:
        processed_env: {}

    - name: Resolve environment variables in env section
      ansible.builtin.set_fact:
        processed_env: "{{ processed_env | combine({item.key: resolved_value}) }}"
      vars:
        var_name_match: "{{ item.value | regex_search('\\$\\{([^}]+)\\}', '\\1') }}"
        var_name: "{{ var_name_match if var_name_match else '' }}"
        # Resolve: check loaded_env_vars first, then system env, else use original
        resolved_value: >-
          {{ item.value | regex_replace('\\$\\{' + var_name + '\\}', loaded_env_vars[var_name])
          if (var_name_match and var_name in loaded_env_vars)
          else (item.value | regex_replace('\\$\\{' + var_name + '\\}', lookup('env', var_name))
          if (var_name_match and lookup('env', var_name)) else item.value) }}
      loop: "{{ mcp_config.env | dict2items }}"

    - name: Add processed environment to config
      ansible.builtin.set_fact:
        processed_mcp_config: "{{ processed_mcp_config | combine({'env': processed_env}) }}"

- name: Validate processed configuration
  ansible.builtin.fail:
    msg: "MCP server '{{ mcp_name }}' has empty command after processing"
  when: processed_mcp_config.command | length == 0

- name: Add processed MCP server to collection
  ansible.builtin.set_fact:
    processed_mcp_servers: "{{ processed_mcp_servers | combine({mcp_name: processed_mcp_config}) }}"

- name: Log successful processing
  ansible.builtin.debug:
    msg: "Successfully processed MCP server: {{ mcp_name }}"
