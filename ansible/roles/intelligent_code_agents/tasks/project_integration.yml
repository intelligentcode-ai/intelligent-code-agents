---
# Project-specific integration tasks
- name: Skip project integration for non-Claude targets
  ansible.builtin.debug:
    msg: "Project integration skipped for agent={{ agent_name }} (Claude-only)."
  when:
    - agent_name != 'claude'
    - ansible_verbosity >= 1

- name: Check if project CLAUDE.md exists
  ansible.builtin.stat:
    path: "{{ agent_project_path }}/CLAUDE.md"
  register: intelligent_code_agents_project_claude_md
  when:
    - agent_name == 'claude'
    - install_claude_integration | default(true) | bool
- name: Backup project CLAUDE.md if exists
  ansible.builtin.copy:
    src: "{{ agent_project_path }}/CLAUDE.md"
    dest: "{{ agent_project_path }}/CLAUDE.md.backup"
    remote_src: true
    mode: '0644'
  when:
    - agent_name == 'claude'
    - install_claude_integration | default(true) | bool
    - intelligent_code_agents_project_claude_md.stat.exists
- name: Create project CLAUDE.md with import
  ansible.builtin.copy:
    content: |
      # Virtual Development Team
      @./{{ agent_dir_name_effective | default('.claude') }}/modes/virtual-team.md
      <!-- Add your project-specific configuration below -->
    dest: "{{ agent_project_path }}/CLAUDE.md"
    mode: '0644'
  when:
    - agent_name == 'claude'
    - install_claude_integration | default(true) | bool
    - not intelligent_code_agents_project_claude_md.stat.exists
- name: Integrate with existing project CLAUDE.md
  when:
    - agent_name == 'claude'
    - install_claude_integration | default(true) | bool
    - intelligent_code_agents_project_claude_md.stat.exists
  block:
    - name: Check if import already present in project CLAUDE.md
      ansible.builtin.command:
        cmd: grep -q "@./{{ agent_dir_name_effective | default('.claude') }}/modes/virtual-team.md" "{{ agent_project_path }}/CLAUDE.md"
      register: intelligent_code_agents_project_import_grep
      failed_when: false
      changed_when: false
    - name: Ensure project CLAUDE.md includes import block
      ansible.builtin.blockinfile:
        path: "{{ agent_project_path }}/CLAUDE.md"
        marker: "<!-- {mark} ICA IMPORT -->"
        block: |
          # Virtual Development Team
          @./{{ agent_dir_name_effective | default('.claude') }}/modes/virtual-team.md
        insertbefore: BOF
      register: intelligent_code_agents_project_import_update
      when: intelligent_code_agents_project_import_grep.rc != 0
    - name: Report project integration status
      ansible.builtin.debug:
        msg: >-
          {{ 'Added import to project CLAUDE.md'
          if intelligent_code_agents_project_import_update is defined
          and intelligent_code_agents_project_import_update.changed
          else 'Project already integrated' }}
