---
# Main tasks for intelligent-code-agents installation
- name: Validate installation parameters
  ansible.builtin.assert:
    that:
      - agent_install_path is defined
      - agent_scope in ['user', 'project']
      - agent_name is defined
    fail_msg: "Invalid installation parameters"
- name: Remove obsolete directories from previous versions
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ agent_install_path }}/commands"
    - "{{ agent_install_path }}/agents"
  failed_when: false
- name: Remove obsolete behavior files from previous versions
  ansible.builtin.file:
    path: "{{ agent_install_path }}/behaviors/{{ item }}"
    state: absent
  loop:
    - agenttask-creation-system.md
    - agenttask-execution.md
    - enforcement-rules.md
    - learning-team-automation.md
    - memory-system.md
    - role-system.md
    - sequential-thinking.md
    - story-breakdown.md
    - template-resolution.md
    - ultrathinking.md
    - validation-system.md
    - shared-patterns
  failed_when: false
- name: Create agent home directory structure (portable)
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ agent_install_path }}"
    - "{{ agent_install_path }}/behaviors"
    - "{{ agent_install_path }}/skills"
    - "{{ agent_install_path }}/roles"
    - "{{ agent_install_path }}/agenttask-templates"
    - "{{ agent_install_path }}/logs"

- name: Create Claude Code integration directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ agent_install_path }}/modes"
    - "{{ agent_install_path }}/hooks"
  when: agent_name == 'claude'
- name: Check if CLAUDE.md exists
  ansible.builtin.stat:
    path: "{{ agent_install_path }}/CLAUDE.md"
  register: intelligent_code_agents_claude_md_exists
  when: agent_name == 'claude'
- name: Backup existing CLAUDE.md if present
  ansible.builtin.copy:
    src: "{{ agent_install_path }}/CLAUDE.md"
    dest: "{{ agent_install_path }}/CLAUDE.md.backup"
    remote_src: true
    mode: '0644'
  when:
    - agent_name == 'claude'
    - intelligent_code_agents_claude_md_exists.stat.exists
- name: Handle graceful integration for existing CLAUDE.md
  ansible.builtin.import_tasks: graceful_integration.yml
  when:
    - agent_name == 'claude'
    - intelligent_code_agents_claude_md_exists.stat.exists
- name: Create new CLAUDE.md for fresh installation
  ansible.builtin.template:
    src: CLAUDE.md.j2
    dest: "{{ agent_install_path }}/CLAUDE.md"
    mode: '0644'
  when:
    - agent_name == 'claude'
    - not intelligent_code_agents_claude_md_exists.stat.exists
- name: Copy virtual team mode files
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/modes/"
    dest: "{{ agent_install_path }}/modes/"
    mode: '0644'
    force: true
  register: intelligent_code_agents_modes_copy_result
  when: agent_name == 'claude'
- name: Display modes preservation notice
  ansible.builtin.debug:
    msg: "Mode files preserved: {{ agent_install_path }}/modes/ already exists - keeping user modifications"
  when:
    - agent_name == 'claude'
    - intelligent_code_agents_modes_copy_result is defined
    - intelligent_code_agents_modes_copy_result.failed
    - ansible_verbosity >= 1
- name: Copy behavior files
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/behaviors/"
    dest: "{{ agent_install_path }}/behaviors/"
    mode: '0644'
    force: true
  register: intelligent_code_agents_behaviors_copy_result
- name: Display behaviors preservation notice
  ansible.builtin.debug:
    msg: "Behavior files preserved: {{ agent_install_path }}/behaviors/ already exists - keeping user modifications"
  when: intelligent_code_agents_behaviors_copy_result.failed and ansible_verbosity >= 1
- name: Copy skills directory
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/skills/"
    dest: "{{ agent_install_path }}/skills/"
    mode: '0644'
    force: true
  register: intelligent_code_agents_skills_copy_result
- name: Display skills preservation notice
  ansible.builtin.debug:
    msg: "Skills directory preserved: {{ agent_install_path }}/skills/ already exists - keeping user modifications"
  when: intelligent_code_agents_skills_copy_result.failed and ansible_verbosity >= 1
- name: Copy roles directory
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/roles/"
    dest: "{{ agent_install_path }}/roles/"
    mode: '0644'
    force: true
  register: intelligent_code_agents_roles_copy_result
- name: Display roles preservation notice
  ansible.builtin.debug:
    msg: >-
      Roles directory preserved: {{ agent_install_path }}/roles/
      already exists - keeping user modifications
  when: intelligent_code_agents_roles_copy_result.failed and ansible_verbosity >= 1
- name: Copy AgentTask templates directory
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/agenttask-templates/"
    dest: "{{ agent_install_path }}/agenttask-templates/"
    mode: '0644'
    force: true
  register: intelligent_code_agents_agenttask_templates_copy_result
- name: Display AgentTask templates preservation notice
  ansible.builtin.debug:
    msg: >-
      AgentTask templates directory preserved:
      {{ agent_install_path }}/agenttask-templates/
      already exists - keeping user modifications
  when: intelligent_code_agents_agenttask_templates_copy_result.failed and ansible_verbosity >= 1
- name: Copy hooks directory (excluding node_modules)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/hooks/"
    dest: "{{ agent_install_path }}/hooks/"
    mode: preserve
    force: true
  register: intelligent_code_agents_hooks_copy_result
  when: agent_name == 'claude'
- name: Ensure hooks subdirectories are copied
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/hooks/{{ item }}/"
    dest: "{{ agent_install_path }}/hooks/{{ item }}/"
    mode: preserve
    force: true
  loop:
    - lib
  failed_when: false
  when: agent_name == 'claude'
- name: Display hooks preservation notice
  ansible.builtin.debug:
    msg: >-
      Hooks directory preserved: {{ agent_install_path }}/hooks/
      already exists - keeping user modifications
  when:
    - agent_name == 'claude'
    - intelligent_code_agents_hooks_copy_result is defined
    - intelligent_code_agents_hooks_copy_result.failed
    - ansible_verbosity >= 1
- name: Make all hook scripts executable
  ansible.builtin.file:
    path: "{{ agent_install_path }}/hooks/{{ item }}"
    mode: '0755'
    state: file
  loop:
    - agent-infrastructure-protection.js
    - summary-file-enforcement.js
  failed_when: false
  when: agent_name == 'claude'
- name: Copy VERSION file
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/VERSION"
    dest: "{{ agent_install_path }}/VERSION"
    mode: '0644'
    force: true
  register: intelligent_code_agents_version_copy_result
- name: Display VERSION preservation notice
  ansible.builtin.debug:
    msg: >-
      VERSION file preserved: {{ agent_install_path }}/VERSION already exists
      - keeping user modifications
  when: intelligent_code_agents_version_copy_result.failed and ansible_verbosity >= 1
- name: Check if config.md exists
  ansible.builtin.stat:
    path: "{{ agent_install_path }}/config.md"
  register: intelligent_code_agents_config_md_exists
- name: Ensure hooks lib directory exists
  ansible.builtin.file:
    path: "{{ agent_install_path }}/hooks/lib"
    state: directory
    mode: '0755'
  when: agent_name == 'claude'
- name: Create config.md from template (ONLY if not exists)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../src/config.md"
    dest: "{{ agent_install_path }}/config.md"
    mode: '0644'
  when: not intelligent_code_agents_config_md_exists.stat.exists
- name: Display config preservation notice
  ansible.builtin.debug:
    msg: >-
      Config file preserved: {{ agent_install_path }}/config.md already exists
      - keeping user settings
  when:
    - intelligent_code_agents_config_md_exists.stat.exists
    - ansible_verbosity >= 1
- name: Copy configuration file (selected or default without overwriting user edits)
  block:
    - name: Use provided config_file when specified (overwrite)
      ansible.builtin.copy:
        src: "{{ agent_config_source }}"
        dest: "{{ agent_install_path }}/ica.config.json"
        mode: '0644'
        force: true
      when: agent_config_source | length > 0
    - name: Check existing ica.config.json
      ansible.builtin.stat:
        path: "{{ agent_install_path }}/ica.config.json"
      register: intelligent_code_agents_icc_config_exists
      when: agent_config_source | length == 0
    - name: Preserve existing ica.config.json (no config_file supplied)
      ansible.builtin.debug:
        msg: "Existing ica.config.json detected â€“ leaving it untouched (pass CONFIG_FILE to override)."
      when:
        - agent_config_source | length == 0
        - intelligent_code_agents_icc_config_exists.stat.exists
        - ansible_verbosity >= 1
    - name: Install default ica.config.json only if missing
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../ica.config.default.json"
        dest: "{{ agent_install_path }}/ica.config.json"
        mode: '0644'
        force: false
      when:
        - agent_config_source | length == 0
        - not intelligent_code_agents_icc_config_exists.stat.exists
    - name: Always install default for reference
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../ica.config.default.json"
        dest: "{{ agent_install_path }}/ica.config.default.json"
        mode: '0644'
        force: true
    - name: Display config installation choice
      ansible.builtin.debug:
        msg: >-
          Configuration installed or preserved at {{ agent_install_path }}/ica.config.json
          (source={{ agent_config_source | default('existing or ica.config.default.json') }})
      when: ansible_verbosity >= 1
- name: Copy default workflow configuration file (JSON format)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../ica.workflow.default.json"
    dest: "{{ agent_install_path }}/ica.workflow.default.json"
    mode: '0644'
    force: true
  register: intelligent_code_agents_default_workflow_copy_result
- name: Display default workflow installation notice
  ansible.builtin.debug:
    msg: >-
      Default workflow configuration installed:
      {{ agent_install_path }}/ica.workflow.default.json
      - complete workflow settings available
  when: ansible_verbosity >= 1
- name: Check if settings.json exists
  ansible.builtin.stat:
    path: "{{ agent_install_path }}/settings.json"
  register: intelligent_code_agents_settings_json_exists
  when: agent_name == 'claude'
- name: Create settings.json with hook registration (ONLY if not exists)
  ansible.builtin.template:
    src: settings.json.j2
    dest: "{{ agent_install_path }}/settings.json"
    mode: '0644'
  when:
    - agent_name == 'claude'
    - not intelligent_code_agents_settings_json_exists.stat.exists
- name: Merge hooks into existing settings.json
  when:
    - agent_name == 'claude'
    - intelligent_code_agents_settings_json_exists.stat.exists
  block:
    - name: Read existing settings.json
      ansible.builtin.slurp:
        src: "{{ agent_install_path }}/settings.json"
      register: intelligent_code_agents_existing_settings
    - name: Parse existing settings as JSON
      ansible.builtin.set_fact:
        intelligent_code_agents_settings_data: >-
          {{ intelligent_code_agents_existing_settings.content
          | b64decode
          | from_json }}
    - name: Clean up obsolete hooks while preserving user hooks
      ansible.builtin.set_fact:
        intelligent_code_agents_cleaned_hooks: >-
          {{ (intelligent_code_agents_settings_data.hooks | default({}))
          | dict2items
          | rejectattr('key', 'in', ['PreToolUse', 'Stop', 'SubagentStop', 'SessionStart', 'UserPromptSubmit'])
          | items2dict }}
    - name: Load production hooks configuration from template
      ansible.builtin.set_fact:
        intelligent_code_agents_production_hooks:
          PreToolUse:
            - matcher: "*"
              hooks:
                - type: command
                  command: "node {{ agent_install_path }}/hooks/agent-infrastructure-protection.js"
                  timeout: 5000
                - type: command
                  command: "node {{ agent_install_path }}/hooks/summary-file-enforcement.js"
                  timeout: 5000
    - name: Merge production hooks with cleaned hooks
      ansible.builtin.set_fact:
        intelligent_code_agents_merged_settings: >-
          {{ intelligent_code_agents_settings_data
          | combine({'hooks': intelligent_code_agents_cleaned_hooks
          | combine(intelligent_code_agents_production_hooks)}, recursive=False)
          }}
    - name: Write merged settings.json
      ansible.builtin.copy:
        content: "{{ intelligent_code_agents_merged_settings | to_nice_json(indent=2) }}"
        dest: "{{ agent_install_path }}/settings.json"
        mode: '0644'
    - name: Report hook registration
      ansible.builtin.debug:
        msg: >-
          Production hooks configured in settings.json (infra protection,
          summary routing)
- name: Display settings creation notice
  ansible.builtin.debug:
    msg: >-
      Settings file created with minimal PreToolUse hooks (infra
      protection, summaries)
  when:
    - agent_name == 'claude'
    - not intelligent_code_agents_settings_json_exists.stat.exists
    - ansible_verbosity >= 1
# badges.md file removed - scoring system simplified to clean progress reporting
# learning-callouts.md file removed - integrated into learning-team-automation.md system
- name: Handle project-specific integration
  ansible.builtin.import_tasks: project_integration.yml
  when:
    - agent_scope == "project"
    - agent_name == 'claude'
# Memory skill npm dependencies - OPT-IN due to supply-chain risk
# (better-sqlite3 compiles native code, @xenova/transformers downloads large models)
# Set install_memory_deps=true to enable, or run manually: npm install in skills/memory/
- name: Display memory skill manual installation notice
  ansible.builtin.debug:
    msg: >-
      Memory skill: For enhanced search, manually run 'npm install' in
      {{ agent_install_path }}/skills/memory/ (downloads ~80MB model)
  when:
    - not (install_memory_deps | default(false) | bool)
    - ansible_verbosity >= 1
- name: Check if npm is available for memory skill
  ansible.builtin.command: which npm
  register: intelligent_code_agents_npm_check
  failed_when: false
  changed_when: false
  when: install_memory_deps | default(false) | bool
- name: Check if memory skill dependencies exist
  ansible.builtin.stat:
    path: "{{ agent_install_path }}/skills/memory/node_modules"
  register: intelligent_code_agents_memory_node_modules
  when: install_memory_deps | default(false) | bool
- name: Install memory skill dependencies (opt-in)
  ansible.builtin.command:
    cmd: npm install --production
    chdir: "{{ agent_install_path }}/skills/memory"
  when:
    - install_memory_deps | default(false) | bool
    - intelligent_code_agents_npm_check.rc | default(-1) == 0
    - not (intelligent_code_agents_memory_node_modules.stat.exists | default(false))
  register: intelligent_code_agents_memory_npm_install
  failed_when: false
  changed_when: intelligent_code_agents_memory_npm_install.rc | default(-1) == 0
- name: Display memory skill installation notice
  ansible.builtin.debug:
    msg: "Memory skill: SQLite + embeddings installed for hybrid search"
  when:
    - install_memory_deps | default(false) | bool
    - intelligent_code_agents_memory_npm_install.rc | default(-1) == 0
    - ansible_verbosity >= 1
- name: Display installation summary
  ansible.builtin.debug:
    msg:
      - "âœ… Installation complete!"
      - "ğŸ“ Location: {{ agent_install_path }}"
      - "ğŸ¯ Skills: 35 cross-platform skills (roles, commands, workflows, memory)"
      - "ğŸ¤– Virtual Team: 14 core roles + unlimited specialists"
      - "ğŸ”’ Behavioral Hooks: PreToolUse (infra protection, summaries)"
      - "ğŸš€ Use role skills by name (pm, architect, developer, reviewer, etc.) or /skill-name (if supported) to activate capabilities"
