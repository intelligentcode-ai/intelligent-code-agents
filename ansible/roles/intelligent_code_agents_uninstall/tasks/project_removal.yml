---
# Project-specific removal tasks

- name: Check if project CLAUDE.md exists
  ansible.builtin.stat:
    path: "{{ agent_project_path }}/CLAUDE.md"
  register: intelligent_code_agents_uninstall_project_claude_md

- name: Handle project CLAUDE.md removal
  when: intelligent_code_agents_uninstall_project_claude_md.stat.exists
  block:
    - name: Check if import line exists in project CLAUDE.md
      ansible.builtin.command:
        cmd: >-
          grep -Eq "@(~/|\\./){{ (agent_dir_name_effective | default('.claude')) | replace('.', '\\\\.') }}/modes/virtual-team\\.md"
          "{{ agent_project_path }}/CLAUDE.md"
      register: intelligent_code_agents_uninstall_project_import_present
      failed_when: false
      changed_when: false

    - name: Process project CLAUDE.md with import line
      when: intelligent_code_agents_uninstall_project_import_present.rc == 0
      block:
        - name: Check if project backup exists
          ansible.builtin.stat:
            path: "{{ agent_project_path }}/CLAUDE.md.backup"
          register: intelligent_code_agents_uninstall_project_backup_exists

        - name: Restore project CLAUDE.md from backup
          ansible.builtin.copy:
            src: "{{ agent_project_path }}/CLAUDE.md.backup"
            dest: "{{ agent_project_path }}/CLAUDE.md"
            remote_src: true
            mode: '0644'
          when: intelligent_code_agents_uninstall_project_backup_exists.stat.exists
          register: intelligent_code_agents_uninstall_project_backup_restored

        - name: Remove project backup file after restoration
          ansible.builtin.file:
            path: "{{ agent_project_path }}/CLAUDE.md.backup"
            state: absent
          when: intelligent_code_agents_uninstall_project_backup_exists.stat.exists
          failed_when: false

        - name: Remove virtual team integration from project CLAUDE.md (no backup case)
          when: not intelligent_code_agents_uninstall_project_backup_exists.stat.exists
          block:
            - name: Read project CLAUDE.md content
              ansible.builtin.slurp:
                src: "{{ agent_project_path }}/CLAUDE.md"
              register: intelligent_code_agents_uninstall_project_content

            - name: Remove import line from project
              ansible.builtin.lineinfile:
                path: "{{ agent_project_path }}/CLAUDE.md"
                line: "@~/.claude/modes/virtual-team.md"
                state: absent

            - name: Remove project-scope import line from project
              ansible.builtin.lineinfile:
                path: "{{ agent_project_path }}/CLAUDE.md"
                line: "@./{{ agent_dir_name_effective | default('.claude') }}/modes/virtual-team.md"
                state: absent

            - name: Remove virtual team header from project
              ansible.builtin.lineinfile:
                path: "{{ agent_project_path }}/CLAUDE.md"
                line: "# Virtual Development Team"
                state: absent

            - name: Remove project configuration comment
              ansible.builtin.lineinfile:
                path: "{{ agent_project_path }}/CLAUDE.md"
                line: "<!-- Add your project-specific configuration below -->"
                state: absent

            - name: Check if project CLAUDE.md is effectively empty
              ansible.builtin.shell: |
                set -o pipefail
                grep -v '^[[:space:]]*$' "{{ agent_project_path }}/CLAUDE.md" | wc -l
              register: intelligent_code_agents_uninstall_project_content_lines
              changed_when: false

            - name: Remove empty project CLAUDE.md file
              ansible.builtin.file:
                path: "{{ agent_project_path }}/CLAUDE.md"
                state: absent
              when: intelligent_code_agents_uninstall_project_content_lines.stdout | int == 0

            - name: Report project manual removal
              ansible.builtin.debug:
                msg: >-
                  Removed virtual team integration from project CLAUDE.md -
                  {{ 'file removed (was empty)'
                     if intelligent_code_agents_uninstall_project_content_lines.stdout | int == 0
                     else 'user content preserved' }}

        - name: Report project backup restoration
          ansible.builtin.debug:
            msg: "Restored project CLAUDE.md from backup - original content recovered"
          when: intelligent_code_agents_uninstall_project_backup_exists.stat.exists

    - name: Report no project integration found
      ansible.builtin.debug:
        msg: "No virtual team integration found in project CLAUDE.md"
      when: intelligent_code_agents_uninstall_project_import_present.rc != 0

- name: Report no project CLAUDE.md found
  ansible.builtin.debug:
    msg: "No project CLAUDE.md found at {{ agent_project_path }}"
  when: not intelligent_code_agents_uninstall_project_claude_md.stat.exists
