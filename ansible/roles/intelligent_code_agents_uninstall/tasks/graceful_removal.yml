---
# Graceful removal from existing CLAUDE.md
- name: Check if CLAUDE.md exists
  ansible.builtin.stat:
    path: "{{ agent_install_path }}/CLAUDE.md"
  register: intelligent_code_agents_uninstall_claude_md_exists
- name: Handle CLAUDE.md removal
  when: intelligent_code_agents_uninstall_claude_md_exists.stat.exists
  block:
    - name: Check if import line exists
      ansible.builtin.command:
        cmd: >-
          grep -Eq "@(~/|\\./){{ (agent_dir_name_effective | default('.claude')) | replace('.', '\\\\.') }}/modes/virtual-team\\.md"
          "{{ agent_install_path }}/CLAUDE.md"
      register: intelligent_code_agents_uninstall_import_present
      failed_when: false
      changed_when: false
    - name: Process CLAUDE.md with import line
      when: intelligent_code_agents_uninstall_import_present.rc == 0
      block:
        - name: Read current CLAUDE.md content
          ansible.builtin.slurp:
            src: "{{ agent_install_path }}/CLAUDE.md"
          register: intelligent_code_agents_uninstall_current_content
        - name: Check if backup exists
          ansible.builtin.stat:
            path: "{{ agent_install_path }}/CLAUDE.md.backup"
          register: intelligent_code_agents_uninstall_backup_exists
        - name: Restore from backup if available
          ansible.builtin.copy:
            src: "{{ agent_install_path }}/CLAUDE.md.backup"
            dest: "{{ agent_install_path }}/CLAUDE.md"
            remote_src: true
            mode: '0644'
          when: intelligent_code_agents_uninstall_backup_exists.stat.exists
          register: intelligent_code_agents_uninstall_backup_restored
        - name: Remove backup file after restoration
          ansible.builtin.file:
            path: "{{ agent_install_path }}/CLAUDE.md.backup"
            state: absent
          when: intelligent_code_agents_uninstall_backup_exists.stat.exists
          failed_when: false
        - name: Remove virtual team integration from CLAUDE.md (no backup case)
          when: not intelligent_code_agents_uninstall_backup_exists.stat.exists
          block:
            - name: Remove import line
              ansible.builtin.lineinfile:
                path: "{{ agent_install_path }}/CLAUDE.md"
                line: "@~/.claude/modes/virtual-team.md"
                state: absent

            - name: Remove project-scope import line
              ansible.builtin.lineinfile:
                path: "{{ agent_install_path }}/CLAUDE.md"
                line: "@./{{ agent_dir_name_effective | default('.claude') }}/modes/virtual-team.md"
                state: absent
            - name: Remove virtual team header line
              ansible.builtin.lineinfile:
                path: "{{ agent_install_path }}/CLAUDE.md"
                line: "# Virtual Development Team"
                state: absent
            - name: Remove empty preservation comment
              ansible.builtin.lineinfile:
                path: "{{ agent_install_path }}/CLAUDE.md"
                line: "<!-- Existing project configuration preserved below -->"
                state: absent
            - name: Check if CLAUDE.md is effectively empty
              ansible.builtin.shell: |
                set -o pipefail
                grep -v '^[[:space:]]*$' "{{ agent_install_path }}/CLAUDE.md" | wc -l
              register: intelligent_code_agents_uninstall_content_lines
              changed_when: false
            - name: Remove empty CLAUDE.md file
              ansible.builtin.file:
                path: "{{ agent_install_path }}/CLAUDE.md"
                state: absent
              when: intelligent_code_agents_uninstall_content_lines.stdout | int == 0
            - name: Report manual removal
              ansible.builtin.debug:
                msg: >-
                  Removed virtual team integration from CLAUDE.md -
                  {{ 'file removed (was empty)'
                     if intelligent_code_agents_uninstall_content_lines.stdout | int == 0
                     else 'user content preserved' }}
        - name: Report backup restoration
          ansible.builtin.debug:
            msg: "Restored CLAUDE.md from backup - original content recovered"
          when: intelligent_code_agents_uninstall_backup_exists.stat.exists
    - name: Report no integration found
      ansible.builtin.debug:
        msg: "No virtual team integration found in CLAUDE.md"
      when: intelligent_code_agents_uninstall_import_present.rc != 0
- name: Report no CLAUDE.md found
  ansible.builtin.debug:
    msg: "No CLAUDE.md found at {{ agent_install_path }}"
  when: not intelligent_code_agents_uninstall_claude_md_exists.stat.exists
