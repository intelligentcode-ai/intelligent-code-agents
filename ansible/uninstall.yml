---
# Intelligent Code Agents - Uninstall Playbook
# Runs from control machine, uninstalls from targets via SSH
# NO Ansible required on target machines!

- name: Uninstall Intelligent Code Agents
  hosts: all
  gather_facts: true
  gather_subset:
    - '!all'
    - '!min'
    - env
  vars:
    target_path: "{{ target_path | default('') }}"

  tasks:
    - name: Determine agent target and home directory name
      ansible.builtin.set_fact:
        agent_name: "{{ agent | default('claude') }}"
        agent_dir_name_effective: >-
          {{
            agent_dir_name
            | default(
              '.claude' if (agent | default('claude')) == 'claude'
              else '.codex' if (agent | default('claude')) == 'codex'
              else '.cursor' if (agent | default('claude')) == 'cursor'
              else '.gemini' if (agent | default('claude')) == 'gemini'
              else '.antigravity' if (agent | default('claude')) == 'antigravity'
              else '.agent'
            )
          }}

    - name: Determine uninstall scope and path
      ansible.builtin.set_fact:
        target_scope: "{{ 'project' if target_path else 'user' }}"
        install_path: "{{ (target_path | realpath) + '/' + agent_dir_name_effective if target_path else ansible_env.HOME + '/' + agent_dir_name_effective }}"
        project_path: "{{ target_path | realpath if target_path else '' }}"

    - name: Display uninstall target
      ansible.builtin.debug:
        msg: "Uninstalling from: {{ install_path }}"

    - name: Uninstall via ICA CLI (local connection user scope)
      ansible.builtin.command:
        argv:
          - "{{ playbook_dir }}/../scripts/run-ica-cli.sh"
          - uninstall
          - --yes
          - --targets={{ agent_name }}
          - --scope=user
          - --mode={{ install_mode | default('symlink') }}
          - --agent-dir-name={{ agent_dir_name_effective }}
          - --force={{ force_remove | default(false) | bool }}
      when:
        - ansible_connection == 'local'
        - use_ica_cli | default(true) | bool
        - target_scope == 'user'

    - name: Uninstall via ICA CLI (local connection project scope)
      ansible.builtin.command:
        argv:
          - "{{ playbook_dir }}/../scripts/run-ica-cli.sh"
          - uninstall
          - --yes
          - --targets={{ agent_name }}
          - --scope=project
          - --project-path={{ project_path }}
          - --mode={{ install_mode | default('symlink') }}
          - --agent-dir-name={{ agent_dir_name_effective }}
          - --force={{ force_remove | default(false) | bool }}
      when:
        - ansible_connection == 'local'
        - use_ica_cli | default(true) | bool
        - target_scope == 'project'

    - name: End play after ICA CLI uninstall path
      meta: end_play
      when:
        - ansible_connection == 'local'
        - use_ica_cli | default(true) | bool

    - name: Include intelligent_code_agents uninstall role
      ansible.builtin.include_role:
        name: intelligent_code_agents_uninstall
      vars:
        agent_install_path: "{{ install_path }}"
        agent_project_path: "{{ project_path }}"
        agent_scope: "{{ target_scope }}"
